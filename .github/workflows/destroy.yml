# =============================================================================
# SYNCLEDGER - DESTROY INFRASTRUCTURE
# Tears down all AWS resources when the project is no longer needed
# Requires manual confirmation via environment protection rules
# =============================================================================

name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - staging
      confirm:
        description: 'Type "DESTROY" to confirm destruction of all resources'
        required: true
        type: string

env:
  TF_VAR_aws_region: ${{ vars.AWS_REGION || 'us-east-1' }}
  TF_VAR_environment: ${{ inputs.environment }}
  TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
  TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
  TF_VAR_ec2_key_name: ${{ vars.EC2_KEY_NAME || '' }}
  TF_VAR_domain_name: ${{ vars.DOMAIN_NAME || '' }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}

permissions:
  contents: read

jobs:
  # ---- Validate Confirmation ----
  validate:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "DESTROY" ]; then
            echo "❌ Confirmation failed!"
            echo "You must type 'DESTROY' to confirm resource destruction."
            exit 1
          fi
          echo "✅ Confirmation received. Proceeding with destruction..."

  # ---- Terraform Destroy Plan ----
  destroy-plan:
    name: Destroy Plan
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Destroy Plan
        working-directory: terraform
        run: |
          echo "╔═══════════════════════════════════════════════════════════╗"
          echo "║  ⚠️  RESOURCES THAT WILL BE DESTROYED                    ║"
          echo "╚═══════════════════════════════════════════════════════════╝"
          terraform plan -destroy -input=false

  # ---- Terraform Destroy ----
  destroy:
    name: Destroy Resources
    runs-on: ubuntu-latest
    needs: destroy-plan
    environment: destroy-${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Stop Application Containers
        continue-on-error: true
        run: |
          # Try to get instance ID from terraform state
          cd terraform
          INSTANCE_ID=$(terraform output -raw ec2_instance_id 2>/dev/null || echo "")
          
          if [ -n "$INSTANCE_ID" ]; then
            echo "Stopping containers on instance $INSTANCE_ID..."
            aws ssm send-command \
              --instance-ids "$INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --parameters 'commands=["cd /opt/syncledger && docker-compose -f docker-compose.prod.yml down -v 2>/dev/null || true"]' \
              --timeout-seconds 60 \
              --region ${{ env.AWS_REGION }} || true
            sleep 15
          fi

      - name: Terraform Destroy
        working-directory: terraform
        run: |
          terraform destroy \
            -auto-approve \
            -input=false

      - name: Destruction Summary
        run: |
          echo ""
          echo "╔═══════════════════════════════════════════════════════════╗"
          echo "║           ALL RESOURCES DESTROYED                         ║"
          echo "╠═══════════════════════════════════════════════════════════╣"
          echo "║  Environment:  ${{ inputs.environment }}"
          echo "║  Destroyed:    $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "║                                                           ║"
          echo "║  Resources removed:                                       ║"
          echo "║    - EC2 Instance                                         ║"
          echo "║    - Elastic IP                                           ║"
          echo "║    - Security Group                                       ║"
          echo "║    - S3 Bucket (invoices)                                 ║"
          echo "║    - IAM Role & Instance Profile                         ║"
          echo "║    - CloudWatch Log Group                                 ║"
          echo "║    - SSM Parameters                                       ║"
          echo "║    - IAM Deployer User & Policy                          ║"
          echo "║                                                           ║"
          echo "║  ⚠️ Monthly AWS charges will stop immediately.            ║"
          echo "╚═══════════════════════════════════════════════════════════╝"
