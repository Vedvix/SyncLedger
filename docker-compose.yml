# =============================================================================
# SYNCLEDGER - DOCKER COMPOSE CONFIGURATION
# Multi-tenant Invoice Processing SaaS Platform
# by vedvix
# =============================================================================
# This file sets up all required services for local development.
# 
# Quick Start:
#   docker-compose up -d                    # Start core services (postgres)
#   docker-compose --profile backend up -d  # Start with backend
#   docker-compose --profile all up -d      # Start all services
#
# Environment Variables:
#   Copy .env.example to .env and configure your credentials
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: syncledger-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: syncledger
      POSTGRES_USER: syncledger
      POSTGRES_PASSWORD: ${DB_PASSWORD:-syncledger123}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U syncledger -d syncledger"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - syncledger-network

  # ===========================================================================
  # Spring Boot Backend
  # ===========================================================================
  backend:
    build:
      context: ./syncledger-backend
      dockerfile: Dockerfile
    container_name: syncledger-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/syncledger
      SPRING_DATASOURCE_USERNAME: syncledger
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-syncledger123}
      JWT_SECRET: ${JWT_SECRET:-syncledger-dev-jwt-secret-key-min-256-bits-long}
      AZURE_CLIENT_ID: ${AZURE_CLIENT_ID:-}
      AZURE_CLIENT_SECRET: ${AZURE_CLIENT_SECRET:-}
      AZURE_TENANT_ID: ${AZURE_TENANT_ID:-}
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      AWS_ACCESS_KEY: ${AWS_ACCESS_KEY:-test}
      AWS_SECRET_KEY: ${AWS_SECRET_KEY:-test}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-syncledger-invoices}
      PDF_SERVICE_URL: http://pdf-service:8001
      EMAIL_POLLING_ENABLED: ${EMAIL_POLLING_ENABLED:-false}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:5173,http://localhost:8080,http://frontend}
    ports:
      - "8080:8080"
    volumes:
      - uploads_data:/app/uploads
    networks:
      - syncledger-network
    profiles:
      - backend
      - all

  # ===========================================================================
  # Python PDF Microservice
  # ===========================================================================
  pdf-service:
    build:
      context: ./pdf-microservice
      dockerfile: Dockerfile
    container_name: syncledger-pdf
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://syncledger:${DB_PASSWORD:-syncledger123}@postgres:5432/syncledger
      CORS_ORIGINS: http://localhost:3000,http://localhost:5173,http://localhost:8080
    ports:
      - "8001:8001"
    volumes:
      - pdf_temp:/tmp/pdf_processing
    networks:
      - syncledger-network
    profiles:
      - backend
      - all

  # ===========================================================================
  # React Frontend
  # ===========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${API_URL:-http://localhost:8080/api}
    container_name: syncledger-frontend
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "3000:80"
    networks:
      - syncledger-network
    profiles:
      - frontend
      - all

  # ===========================================================================
  # pgAdmin - PostgreSQL Web UI
  # ===========================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: syncledger-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@syncledger.local
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - syncledger-network
    profiles:
      - tools

  # ===========================================================================
  # LocalStack - AWS Services Mock (S3, SQS)
  # ===========================================================================
  localstack:
    image: localstack/localstack:latest
    container_name: syncledger-localstack
    restart: unless-stopped
    environment:
      SERVICES: s3,sqs
      DEFAULT_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      DATA_DIR: /var/lib/localstack/data
    ports:
      - "4566:4566"
    volumes:
      - localstack_data:/var/lib/localstack
    networks:
      - syncledger-network
    profiles:
      - aws
      - all

# ===========================================================================
# Volumes
# ===========================================================================
volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  localstack_data:
    driver: local
  pdf_temp:
    driver: local
  uploads_data:
    driver: local

# ===========================================================================
# Networks
# ===========================================================================
networks:
  syncledger-network:
    driver: bridge
